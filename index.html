<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫療綜合釋疑小幫手 (Medical Query Router)</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Password Overlay -->
    <div id="password-overlay"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <div
            style="background: #ffffff; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 400px; width: 90%;">
            <h2 style="margin-top: 0; color: #333; font-size: 1.5em; margin-bottom: 10px;">醫療綜合釋疑小幫手</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 24px; line-height: 1.5;">
                本測試系統受密碼保護，<br>請輸入存取密碼以喚醒後端微服務。</p>
            <div style="display: flex; gap: 10px;">
                <input type="password" id="demo-password-input" placeholder="請輸入存取密碼"
                    style="padding: 12px 16px; border: 1px solid #ccc; border-radius: 6px; flex: 1; font-size: 14px; outline: none;">
                <button id="demo-password-btn" class="primary-btn"
                    style="padding: 12px 20px; border-radius: 6px;">解鎖</button>
            </div>
            <div id="demo-password-error"
                style="color: #e74c3c; font-size: 13px; margin-top: 15px; display: none; font-weight: bold;">
                密碼錯誤或伺服器無回應，請重試</div>
            <div id="demo-password-loading" style="color: #3498db; font-size: 13px; margin-top: 15px; display: none;">
                正在驗證與喚醒後端伺服器 (可能需時 10 秒) ...</div>
        </div>
    </div>
    <div class="app-container">
        <!-- 左半邊：後端運行終端機 -->
        <div class="left-pane">
            <div class="terminal-header">
                <span class="dot red"></span>
                <span class="dot yellow"></span>
                <span class="dot green"></span>
                <span class="terminal-title">Backend Terminal Simulator</span>
            </div>
            <div class="terminal-content" id="terminal-content">
                <div class="log-line system-log">Waiting for requests...</div>
            </div>
        </div>

        <!-- 右半邊：使用者互動區 -->
        <div class="right-pane">
            <div class="chat-header" style="padding-bottom: 10px;">
                <div
                    style="display: flex; justify-content: center; align-items: baseline; gap: 10px; margin-bottom: 5px;">
                    <h1 style="margin: 0; font-size: 1.5em;">醫療綜合釋疑小幫手 (DEMO)</h1>
                    <span style="font-size: 13px; color: #666;">開發者：陳劭杰 saujay@gmail.com</span>
                </div>
                <div
                    style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <button id="toggle-info-btn" onclick="toggleHeaderInfo()"
                        style="background: none; border: 1px solid #ccc; border-radius: 4px; padding: 4px 12px; font-size: 12px; cursor: pointer; color: #555; display: flex; align-items: center; gap: 5px;">
                        <span>隱藏詳細資訊與警語</span> <span id="header-toggle-icon">▲</span>
                    </button>
                </div>

                <div id="collapsible-header-info"
                    style="overflow: hidden; transition: max-height 1.6s ease-in-out; max-height: 500px;">
                    <p style="font-size: 13px; margin-bottom: 12px; color: #444; line-height: 1.6; padding: 0 10px;">
                        <strong>架構與技術部署：</strong>前端原生 HTML/CSS/JS。後端 C# .NET 8，運行於微軟雲端服務 Azure Consumption Plan
                        免費層，無伺服器微服務架構(Azure Functions)。AI 路由核心整合 Microsoft Semantic Kernel 實作語義路由與動態 Prompt解析。支援 HTTP/2
                        SSE 真即時串流 (FlushAsync)與Markdown格式化輸出，底層串接 OpenRouter / Groq 免費語言模型。
                    </p>
                    <div class="warning-banner"
                        style="display: flex; flex-direction: column; gap: 6px; padding: 12px 16px; background-color: #fff3cd; border-radius: 6px; border: 1px solid #ffeeba; font-size: 12px; color: #856404; margin: 0 auto; max-width: 95%; text-align: left;">
                        <strong style="font-size: 13px; margin-bottom: 2px;">⚠️ 聲明與警語：</strong>
                        <span>1. 非正式醫療診斷，僅供衛教參考。有實質病痛請務必尋求專業醫師協助。</span>
                        <span>2. 測試環境，請勿送出任何真實身分證字號、病歷等隱私或敏感資訊。</span>
                        <span>3. 輸出品質與穩定性受限於免費 AI 語言模型的能力。</span>
                        <span>4. 免費 API 節點可能無回應或出錯，請稍後再試。</span>
                        <span>5. 後端部署於雲端免費層，若閒置太長，喚醒可能需要額外十幾秒以上的冷啟動 (Cold Start) 時間，請耐心等候。</span>
                        <span>6. 此 DEMO 純為技術展示，不會儲存任何歷史資訊，並將於完成面試後立即下架。</span>
                    </div>
                </div>

                <script>
                    function toggleHeaderInfo() {
                        const infoDiv = document.getElementById('collapsible-header-info');
                        const btnText = document.querySelector('#toggle-info-btn span:first-child');
                        const btnIcon = document.getElementById('header-toggle-icon');

                        if (infoDiv.style.maxHeight !== '0px') {
                            // Collapse
                            infoDiv.style.maxHeight = '0px';
                            infoDiv.style.margin = '0'; // Optional: remove margin for tighter collapse
                            btnText.textContent = '顯示詳細資訊與警語';
                            btnIcon.textContent = '▼';
                        } else {
                            // Expand
                            infoDiv.style.maxHeight = '500px'; // Value large enough to contain content
                            btnText.textContent = '隱藏詳細資訊與警語';
                            btnIcon.textContent = '▲';
                        }
                    }


                </script>
            </div>



            <!-- 對話介面 -->
            <div class="chat-container">
                <div class="messages-area" id="messages-area">
                    <div class="message system-message markdown-body">
                        您好！請問有什麼我可以協助您的？（支援報告解讀、用藥疑問等）
                    </div>

                    <!-- 隱藏的載入中動畫 -->
                    <div id="loading-indicator" class="message system-message loading-indicator" style="display: none;">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>



                <div class="input-area">
                    <!-- 警告標語已整合至上方標題 -->

                    <div class="model-selector-container"
                        style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                        <label for="model-select" style="font-weight: bold; color: var(--primary-color);">選擇 AI
                            模型：</label>
                        <select id="model-select"
                            style="flex: 1; padding: 6px; border-radius: 4px; border: 1px solid #ccc;">
                            <option value="openrouter:arcee-ai/trinity-large-preview:free">OpenRouter:
                                arcee-ai/trinity-large-preview:free</option>
                            <option value="openrouter:openai/gpt-oss-120b:free">OpenRouter: openai/gpt-oss-120b:free
                            </option>
                            <option value="groq:openai/gpt-oss-120b">Groq: openai/gpt-oss-120b</option>
                            <option value="groq:meta-llama/llama-4-scout-17b-16e-instruct" selected>Groq:
                                meta-llama/llama-4-scout-17b-16e-instruct</option>
                        </select>
                    </div>

                    <div class="input-form">
                        <div class="textarea-container" style="flex:1; position:relative;">
                            <textarea id="user-input" placeholder="請輸入您的醫療問題..." rows="3"
                                style="width:100%; height:100%; box-sizing:border-box;"></textarea>
                            <button id="clear-input-btn" class="clear-btn" title="清空對話框">✕</button>
                        </div>
                        <button id="send-btn" class="primary-btn">發送 🚀</button>
                    </div>
                </div>
            </div>

            <!-- 測試面板 (移至最下方) -->
            <div class="test-panel">
                <div class="test-panel-header" id="test-panel-toggle">
                    <span>🔬 自動測試面板 (點擊收合)</span>
                    <span id="toggle-icon">▲</span>
                </div>
                <div class="test-panel-content" id="test-panel-content">
                    <div class="test-panel-row">
                        <span style="font-weight:bold; color:var(--primary-color);">問題生產器</span>
                        <input type="text" id="gen-direction-input" placeholder="輸入問題生成方向..."
                            style="flex:1; padding: 6px; border-radius: 4px; border: 1px solid #ccc;" />
                        <button id="generate-btn" class="secondary-btn">🎲 生成</button>
                        <button id="save-generated-btn" class="secondary-btn">💾 存入列表</button>
                    </div>
                    <div class="test-panel-row">
                        <select id="test-case-select" style="flex:1;">
                            <option value="">-- 自訂與預設問題列表 --</option>
                        </select>
                    </div>
                    <div class="test-panel-row" style="justify-content: flex-start; gap: 10px;">
                        <button id="auto-test-btn" class="secondary-btn">🤖 全自動測試</button>
                        <button id="new-chat-btn" class="secondary-btn">🗑️ 新對話</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="app.js"></script>
</body>

</html>